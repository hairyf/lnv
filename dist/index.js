#!/usr/bin/env node
var q=Object.create;var h=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var F=(e,n,r,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of W(n))!A.call(e,o)&&o!==r&&h(e,o,{get:()=>n[o],enumerable:!(s=I(n,o))||s.enumerable});return e};var u=(e,n,r)=>(r=e!=null?q(Y(e)):{},F(n||!e||!e.__esModule?h(r,"default",{value:e,enumerable:!0}):r,e));var l=u(require("pathe")),m=u(require("fs")),f=require("dotenv"),w=require("@manypkg/get-packages"),x=require("child_process");var a={wait_stacks:[],...console,wait(...e){this.wait_stacks.push(...e)},don(...e){e.length&&console.log(...e),this.wait_stacks.forEach(n=>console.log(n)),this.wait_stacks=[],console.log()}};var p=process.cwd();async function b(e,n={}){if(!e){y(`${p}/.env`,n);return}let{packages:r,root:s}=await(0,w.getPackages)(process.cwd());s.dir!==p&&a.warn("Subproject exposes environment. If is correct, ignore this message.");for(let o of r.filter(t=>t.dir!==p))a.wait(` - ${l.default.relative(p,o.dir)}/.env`),y(`${o.dir}/.env`,n)}async function E(e,n){if(Array.isArray(e)&&(e=e.join(" ")),!e)throw new Error("Unable to run empty running script");let{execaSync:r}=await import("execa"),s={stdio:"inherit",env:{...process.env,...n}},o=e.split("&&").map(t=>t.trim());for(let t of o){process.platform.startsWith("win")&&t.includes(".sh")&&!t.startsWith("sh ")&&(t="sh "+t);try{r(t,s)}catch{(0,x.execSync)(t,s)}}}function k(e){e="."+e;let n=T(e);if(!n)return;if(e!==".env.vault")return(0,f.config)({path:n,processEnv:{}});let r=v(".env.key")||process.env.DOTENV_KEY||v(".env");if(!r)throw new Error("no DOTENV_KEY found in .env | .env.key or process.env");return(0,f.config)({DOTENV_KEY:r,path:n})}function T(e){let n=p;for(;n!==l.default.parse(n).root;){let r=l.default.join(n,e);if(m.default.existsSync(r))return r;n=l.default.dirname(n)}}function j(e){return[...new Set([...e])]}function O(e){return e!=="env"?e==="dotenv"?"env.vault":`env.${e}`:e}function v(e){return(0,f.config)({processEnv:{},path:T(e)}).parsed?.DOTENV_KEY}function y(e,n={}){let s=["# This file is generated by lnv command","# DO NOT ATTEMPT TO EDIT THIS FILE",Object.entries(n).map(([o,t])=>`${o}=${t}`).join(`
`)].join(`
`);m.default.writeFileSync(e,s,"utf-8")}function $(e){let n=[],r="",s=!1,o="";for(let t of e)t.startsWith("'")||t.startsWith("`")?s?r+=" "+t.slice(1):(s=!0,o=t[0],r+=t.slice(1)):t.endsWith("'")||t.endsWith("`")?s&&o===t[t.length-1]?(r+=" "+t.slice(0,-1),n.push(r.trim()),r="",s=!1):n.push(t):s?r+=" "+t:n.push(t);return r&&n.push(r.trim()),n}var _=u(require("yargs")),D=require("yargs/helpers");var S="5.4.0";function N(){let e=K($((0,D.hideBin)(process.argv)));return(0,_.default)(e).scriptName("lnv").showHelpOnFail(!1).version(S).usage("lnv <mode> [args]").alias("h","help").alias("v","version").option("run",{describe:"load runtime environment and run any scripts",type:"array",alias:"r"}).option("monorepo",{describe:"apply to packages in the monorepo.",type:"boolean",alias:"m"}).option("expose",{describe:"expose environment variables",alias:"e",type:"boolean"}).option("default",{describe:"the default environment (env|...|env.local) be loaded",alias:"d",type:"boolean"}).help()}function K(e){let n=[],r=[],s=!1;for(let o of e)s?r.push(o):n.push(o),(o==="-r"||o==="--run")&&(s=!0),(o==="-"||o==="--")&&(n.splice(n.length-1,1,"-r"),s=!0);return r.length&&n.push(r.join(" ")),n}var i=N().parse();async function M(){await R().catch(e=>{console.warn(`LNV Error: ${e.message}`),process.exit()})}async function R(){if(!i.e&&!i.r)throw new Error("Missing required --expose|-e or --run|-r options");if(i.m&&i.r)throw new Error("In monorepo, the run script cannot be run");if(i.e&&i.r)throw new Error("Expose and run cannot run simultaneously");let e=[i.d&&"env",...i._||[],i.d&&"local"],n=j(e).filter(Boolean).map(O);n.length||console.warn("No environment variables loaded");let r={},s=[];for(let c of n){let g=k(c);if(!g||g?.error){i.d&&(c==="env"||c==="env.local")||a.log(`Failed to loading ${c} file not found in all scopes`);continue}Object.assign(r,g.parsed),s.unshift(c)}let o=i.e?"exposed":"loaded",t=i.r?"runtime environment":i.m?"packages by":"env",d=`Successfully ${o} ${s.join("|")} to ${t}`;i.r&&n.length&&a.log(d+`
`),i.r&&await E(i.r,r),i.e&&await b(i.m,r),i.e&&n.length&&a.don(d)}M();
